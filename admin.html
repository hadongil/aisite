<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 사이트 관리자</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        h1, h2 { text-align: center; color: #444; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .actions { display: flex; gap: 10px; }
        .actions button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .actions .edit-btn { background-color: #4CAF50; color: white; }
        .actions .delete-btn { background-color: #f44336; color: white; }
        .actions .up-btn, .actions .down-btn { background-color: #2196F3; color: white; }
        .actions button:disabled { background-color: #ccc; cursor: not-allowed; }
        .form-container { margin-top: 30px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #fafafa; }
        .form-container h2 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-container { text-align: right; }
        .btn { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .save-btn { background-color: #007BFF; color: white; }
        .add-btn { background-color: #28a745; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1>AI 사이트 관리자 페이지</h1>

    <div id="data-table"></div>

    <div class="form-container">
        <h2 id="form-title">새 사이트 추가</h2>
        <div class="form-group">
            <label for="category">카테고리</label>
            <select id="category"></select>
            <input type="text" id="new-category" placeholder="새 카테고리 이름" style="margin-top: 10px; display: none;">
        </div>
        <div class="form-group">
            <label for="name">이름</label>
            <input type="text" id="name" required>
        </div>
        <div class="form-group">
            <label for="url">URL</label>
            <input type="text" id="url" required>
        </div>
        <div class="form-group">
            <label for="description">설명</label>
            <textarea id="description" rows="3" required></textarea>
        </div>
        <div class="btn-container">
            <button id="submit-btn" class="btn add-btn">추가하기</button>
        </div>
    </div>
    
    <div class="btn-container" style="margin-top: 30px;">
        <button id="save-all-btn" class="btn save-btn">모든 변경사항 저장</button>
    </div>
</div>

<script src="ai_sites.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const dataTable = document.getElementById('data-table');
    const categorySelect = document.getElementById('category');
    const newCategoryInput = document.getElementById('new-category');
    const nameInput = document.getElementById('name');
    const urlInput = document.getElementById('url');
    const descriptionInput = document.getElementById('description');
    const submitBtn = document.getElementById('submit-btn');
    const saveAllBtn = document.getElementById('save-all-btn');
    const formTitle = document.getElementById('form-title');

    let aiData = JSON.parse(JSON.stringify(aiSitesData)); // Deep copy
    let editState = null; // { category, index }

    // 데이터 로드
    function loadData() {
        renderTable();
        populateCategories();
    }

    // 테이블 렌더링
    function renderTable() {
        dataTable.innerHTML = '';
        for (const category in aiData) {
            const table = document.createElement('table');
            const caption = document.createElement('caption');
            caption.innerHTML = `<h2>${category}</h2>`;
            table.appendChild(caption);

            const thead = `
                <thead>
                    <tr>
                        <th>이름</th>
                        <th>URL</th>
                        <th>설명</th>
                        <th>작업</th>
                    </tr>
                </thead>
            `;
            table.innerHTML += thead;

            const tbody = document.createElement('tbody');
            aiData[category].forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td><a href="${item.url}" target="_blank">${item.url}</a></td>
                    <td>${item.description}</td>
                    <td class="actions">
                        <button class="edit-btn" data-category="${category}" data-index="${index}">수정</button>
                        <button class="delete-btn" data-category="${category}" data-index="${index}">삭제</button>
                        <button class="up-btn" data-category="${category}" data-index="${index}" ${index === 0 ? 'disabled' : ''}>▲</button>
                        <button class="down-btn" data-category="${category}" data-index="${index}" ${index === aiData[category].length - 1 ? 'disabled' : ''}>▼</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            dataTable.appendChild(table);
        }
    }

    // 카테고리 셀렉트 박스 채우기
    function populateCategories() {
        categorySelect.innerHTML = '';
        for (const category in aiData) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        }
        const newOption = document.createElement('option');
        newOption.value = 'new';
        newOption.textContent = '새 카테고리 추가...';
        categorySelect.appendChild(newOption);
    }

    // 폼 초기화
    function resetForm() {
        formTitle.textContent = '새 사이트 추가';
        nameInput.value = '';
        urlInput.value = '';
        descriptionInput.value = '';
        categorySelect.value = categorySelect.options[0].value;
        newCategoryInput.style.display = 'none';
        newCategoryInput.value = '';
        submitBtn.textContent = '추가하기';
        submitBtn.classList.remove('edit-btn');
        submitBtn.classList.add('add-btn');
        editState = null;
    }

    // 카테고리 변경 시
    categorySelect.addEventListener('change', () => {
        if (categorySelect.value === 'new') {
            newCategoryInput.style.display = 'block';
        } else {
            newCategoryInput.style.display = 'none';
        }
    });

    // 추가 또는 수정 버튼 클릭
    submitBtn.addEventListener('click', () => {
        const name = nameInput.value.trim();
        const url = urlInput.value.trim();
        const description = descriptionInput.value.trim();
        let category = categorySelect.value;

        if (category === 'new') {
            category = newCategoryInput.value.trim();
            if (!category) {
                alert('새 카테고리 이름을 입력하세요.');
                return;
            }
        }

        if (!name || !url || !description || !category) {
            alert('모든 필드를 채워주세요.');
            return;
        }

        const newItem = { name, url, description };

        if (editState) { // 수정 모드
            const { oldCategory, index } = editState;
            if (oldCategory !== category) {
                // 카테고리 이동
                aiData[oldCategory].splice(index, 1);
                if (!aiData[oldCategory].length) {
                    delete aiData[oldCategory];
                }
                if (!aiData[category]) {
                    aiData[category] = [];
                }
                aiData[category].push(newItem);
            } else {
                // 기존 카테고리 내에서 수정
                aiData[category][index] = newItem;
            }
        } else { // 추가 모드
            if (!aiData[category]) {
                aiData[category] = [];
            }
            aiData[category].push(newItem);
        }

        renderTable();
        populateCategories();
        resetForm();
    });

    // 테이블 내 버튼 클릭 위임
    dataTable.addEventListener('click', (e) => {
        const target = e.target;
        const category = target.dataset.category;
        const index = parseInt(target.dataset.index, 10);

        if (target.classList.contains('edit-btn')) {
            const item = aiData[category][index];
            formTitle.textContent = '사이트 정보 수정';
            nameInput.value = item.name;
            urlInput.value = item.url;
            descriptionInput.value = item.description;
            categorySelect.value = category;
            newCategoryInput.style.display = 'none';
            submitBtn.textContent = '수정 완료';
            submitBtn.classList.remove('add-btn');
            submitBtn.classList.add('edit-btn');
            editState = { oldCategory: category, index };
            window.scrollTo(0, document.body.scrollHeight); // 폼으로 스크롤
        }

        if (target.classList.contains('delete-btn')) {
            if (confirm(`'${aiData[category][index].name}' 항목을 정말 삭제하시겠습니까?`)) {
                aiData[category].splice(index, 1);
                if (aiData[category].length === 0) {
                    delete aiData[category];
                }
                renderTable();
                populateCategories();
            }
        }

        if (target.classList.contains('up-btn')) {
            if (index > 0) {
                const [item] = aiData[category].splice(index, 1);
                aiData[category].splice(index - 1, 0, item);
                renderTable();
            }
        }

        if (target.classList.contains('down-btn')) {
            if (index < aiData[category].length - 1) {
                const [item] = aiData[category].splice(index, 1);
                aiData[category].splice(index + 1, 0, item);
                renderTable();
            }
        }
    });

    // 모든 변경사항 저장 (개선된 방식)
    saveAllBtn.addEventListener('click', async () => {
        const dataStr = `const aiSitesData = ${JSON.stringify(aiData, null, 4)};`;

        // File System Access API (최신 브라우저 지원)
        if (window.showSaveFilePicker) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: 'ai_sites.js',
                    types: [{
                        description: 'JavaScript Files',
                        accept: { 'text/javascript': ['.js'] },
                    }],
                });
                const writable = await handle.createWritable();
                await writable.write(dataStr);
                await writable.close();
                alert('ai_sites.js 파일이 성공적으로 저장되었습니다.');
                return;
            } catch (err) {
                // 사용자가 파일 선택을 취소한 경우 오류가 아니므로 무시
                if (err.name === 'AbortError') {
                    return;
                }
                console.error('File System Access API 저장 실패:', err);
                // API 실패 시 아래의 다운로드 방식으로 대체
            }
        }

        // 구형 브라우저를 위한 다운로드 방식 (기존 방식)
        try {
            const blob = new Blob([dataStr], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ai_sites.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('ai_sites.js 파일이 다운로드되었습니다. 기존 파일을 이 파일로 교체해주세요.');
        } catch (err) {
            console.error('다운로드 방식 저장 실패:', err);
            alert('파일 저장에 실패했습니다.');
        }
    });

    // 초기 데이터 로드
    loadData();
});
</script>

</body>
</html>